#!/bin/sh

#
# "SystemImager" - Copyright (C) 1999-2000 Brian Elliott Finley <brian@valinux.com>
#

# do we want a quiet install? and do we want to run afterburner?
QUIET="false"
AFTERBURNER="yes"
case $1 in
  -q|-quiet|--quiet ) QUIET="true" ;;
  -no-afterburner|--no-afterburner ) AFTERBURNER="no" ;;
esac
case $2 in
  -q|-quiet|--quiet ) QUIET="true" ;;
  -no-afterburner|--no-afterburner ) AFTERBURNER="no" ;;
esac

# set some variables
PATH=/bin:/usr/bin:/sbin:/usr/sbin
COMMAND_PATH=`dirname $0`
cd $COMMAND_PATH
INSTALL_DIR=`pwd`
VERSION=`cat $INSTALL_DIR/VERSION`

# don't restart inetd unless necessary
RESTART_INETD=no

# if not run as root, install will surely fail
[ `whoami` != "root" ] && echo "Must be run as root!" && exit 1

# source needed functions
. $INSTALL_DIR/functions


### BEGIN introduction ###
if [ $QUIET = "false" ]; then
  clear
  echo "Welcome to SystemImager."
  echo
  echo "This install script may modify the following files and/or directories:"
  echo
  echo " /tftpboot/systemimager -- create if necessary and add appropriate files/links"
  echo " /tftpboot/pxelinux.cfg -- create if necessary and add appropriate files/links"
  echo " /etc/services          -- add rsync and/or tftp entries if necessary"
  echo " /etc/inetd.conf        -- add/modify rsync and tftp entries if necessary"
  echo " /etc/rsyncd.conf       -- it is assumed that SystemImager will manage this"
  echo "                           file and that it will not be used for anything else"
  echo
  echo " All modified files will be backed up with the .beforesystemimager extension."
  echo

  # you sure you want to install?
  echo -n "Install SystemImager? (y/[n]) "
  read REPLY
  case $REPLY in
    y|Y|Yes|yes|YES ) clear; echo Ok.  Installing SystemImager... ;;
                  * ) echo Install cancelled.  No files modified. && exit 1 ;;
  esac

  echo
  sleep 2
fi
### END introduction ###


### BEGIN binaries ###
for BINARY in `ls $INSTALL_DIR/sbin/ | grep -wv CVS`
do
  cp -af $INSTALL_DIR/sbin/$BINARY /usr/sbin/
  chown root:root /usr/sbin/$BINARY
done
### END binaries ###


### BEGIN tftpboot stuff ###
# Create /tftpboot/systemimager/ directory if necessary and copy/link files
if [ ! -d /tftpboot/systemimager/ ]; then
  [ $QUIET = "false" ] && echo "Creating /tftpboot/systemimager/..."
  mkdir -p /tftpboot/systemimager/
else
  [ $QUIET = "false" ] && echo "/tftpboot/systemimager/ already exists..."
fi
[ $QUIET = "false" ] && echo "copying /etc/hosts to /tftpboot/systemimager/hosts..."
cd /tftpboot/systemimager/
cp -f /etc/hosts hosts
# and for the benefit of RPM land...
touch hosts

# gotta make sure the masses can read it...
chmod +r hosts

# copy tftpstuff into tftp area
for TFTP_ITEM in `ls $INSTALL_DIR/tftpstuff/ | grep -wv CVS`
do
  cp -af $INSTALL_DIR/tftpstuff/$TFTP_ITEM /tftpboot/
  chown -R root:root /tftpboot/$TFTP_ITEM
done

# turns out we *can* actually use the exact same config file -- Thanks, H.P. Anvin ;)
cd /tftpboot/pxelinux.cfg/
ln -f syslinux.cfg default
### END tftpboot stuff ###


### BEGIN images stuff ###

# create /var/spool/systemimager
mkdir -p /var/spool/systemimager/images
chmod 750 /var/spool/systemimager/images

# Create Warning file
echo '#' > /var/spool/systemimager/images/README
echo '# "SystemImager" - Copyright (C) 1999-2000 Brian Elliott Finley <brian@valinux.com>' >> /var/spool/systemimager/images/README
echo '#' >> /var/spool/systemimager/images/README
echo '' >> /var/spool/systemimager/images/README
echo '***GOTCHA!***' >> /var/spool/systemimager/images/README
echo '' >> /var/spool/systemimager/images/README
echo 'DO NOT TOUCH THESE DIRECTORIES UNLESS YOU KNOW EXACTLY WHAT YOU ARE DOING!!!' >> /var/spool/systemimager/images/README
echo '' >> /var/spool/systemimager/images/README
echo 'You have the ability to totally hose an entire network of computers if you put' >> /var/spool/systemimager/images/README
echo 'the wrong file in the right place.  OR EVEN MESS UP THE PERMISSIONS ON A FILE.' >> /var/spool/systemimager/images/README
echo '' >> /var/spool/systemimager/images/README
echo 'Permissions, ownership, modes, sticky-bits, etc. are all very important as they' >> /var/spool/systemimager/images/README
echo 'will be replicated *exactly* on the clients!!!' >> /var/spool/systemimager/images/README

# Create extra scary link to warning file
cd /var/spool/systemimager/images
ln -sf README DO_NOT_TOUCH_THESE_DIRECTORIES

### END images stuff ###


### BEGIN documentation and what not stuff ###

# Documentation -- copy BIG CASE files
rm -fr /usr/doc/systemimager-*
mkdir -p /usr/doc/systemimager-$VERSION/
cp -af $INSTALL_DIR/[A-Z]* /usr/doc/systemimager-$VERSION/
chown -R root:root /usr/doc/systemimager-$VERSION/

### END documentation and what not stuff ###


# run afterburner unless told otherwise...
[ $QUIET = "false" ] && [ $AFTERBURNER = "yes" ] && $INSTALL_DIR/afterburner --non-interactive
[ $QUIET = "true" ] && [ $AFTERBURNER = "yes" ] && $INSTALL_DIR/afterburner --non-interactive --quiet

exit 0
