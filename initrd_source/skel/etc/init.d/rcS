#!/bin/sh
#
# "SystemImager" 
#
#  Copyright (C) 1999-2001 Brian Elliott Finley 
#                          <brian@bgsw.net>
#  Copyright (C) 2002-2003 Bald Guy Software 
#                          <brian@bgsw.net>
#
#  $Id$
#
#  Others who have contributed to this code:
#   Charles C. Bennett, Jr. <ccb@acm.org>
#   Sean Dague <japh@us.ibm.com>
#   Dann Frazier <dannf@dannf.org>
#   Curtis Zinzilieta <czinzilieta@valinux.com>
#
# 2004.03.24 Brian Elliott Finley
# - get entire scripts directory at once, whether using rsync or multicast
# 2004.04.02 Brian Elliott Finley
# - tmpfs_watcher must start after boel_binaries
# 2004.04.14 Brian Elliott Finley
# - add preinstallscript support at Rick Bradshaw's request

#set -x         # XXX comment out before each release. -BEF-

#################################################################################
#   Load functions and other variables
#
. /etc/init.d/functions
#
################################################################################

#################################################################################
#
#   main
#
get_arch

switch_root_to_tmpfs

mount_dev_on_devfs

mount_proc

adjust_arch

ifconfig_loopback

load_my_modules

read_local_cfg

start_network
beep

ping_test

start_syslogd

if [ ! -z $FLAMETHROWER_DIRECTORY_PORTBASE ]; then
    get_flamethrower_directory
fi

get_boel_binaries_tarball
beep

tmpfs_watcher

get_scripts_directory

run_preinstall_scripts

autodetect_hardware_and_load_modules

if [ ! -z $SSH_DOWNLOAD_URL ]; then
    echo
    echo start_ssh
    start_ssh
fi

# HOSTNAME may already be set via local.cfg -BEF-
if [ -z $HOSTNAME ]; then
    get_hostname_by_hosts_file
fi

if [ -z $HOSTNAME ]; then
    get_hostname_by_dns
fi

if [ ! -z $HOSTNAME ]; then
    echo
    echo "This hosts name is: $HOSTNAME"
fi

# If neither HOSTNAME or IMAGENAME is set, then we cannot proceed.  
# (IMAGENAME may have been set by local.cfg).  -BEF-
if [ -z $IMAGENAME ] && [ -z $HOSTNAME ]; then
    echo
    echo "HOSTNAME for $IPADDR was not specified in a local.cfg file, and I could"
    echo "not find it via the hosts file or DNS.  Additionally, IMAGENAME was not"
    echo "specified.  I must have one or the other in order to proceed!!!"
    echo
    shellout
fi
    
choose_autoinstall_script

write_variables
beep

run_autoinstall_script
#
#################################################################################

exit 0

