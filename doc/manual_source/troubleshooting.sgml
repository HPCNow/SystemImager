<chapter>
  <title>Troubleshooting</title>
  <para></para>
  <section id=TftpFailure>
    <title>
      PXE installations work fine for a while, but eventually clients no
      longer boot the autoinstall kernel.
    </title>
    <Para>
      Are you using <application>xinetd</application>?
      <application>xinetd</application> 2.1.8.9pre11 (and assumably earlier
      versions) had a race condition which causes the tftp server to suddenly
      stop responding.  this has supposedly been fixed in version
      2.1.8.9pre13.  Also, <application>xinetd</application> and
      <application>inetd</application> have default limits on how many
      connections can be spawned in a 60 second period.  See the inetd or
      xinetd manpage for details on increasing this limit.
    </Para>
  </section>  
  <section id=TroubleAssignHostname>
    <title>
      My client fails to assign a hostname to itself, making the autoinstall
      fail.
    </title>
    <Para>Ryan Braby reported the following problem:</Para>
    <BlockQuote>
      <Para>
	[The install] fails when you have addesses like the following:
      </Para>
      <literallayout>
###.###.###.2
###.###.###.21
###.###.###.22 
###.###.###.23
###.###.###.24
etc.
      </literallayout>
      <Para>
	For the node with the ###.###.###.2 address, the script tries to
	assign multiple hostnames, and then fails to get any install script.
      </Para>
    </BlockQuote>
    <Para>This should be fixed in the next release (1.4.2).</Para>
  </section>
  <section id=Troubleslowrsync>
    <title>
      My client autoinstallation/update hangs, crashes, or is ridiculously
      slow.
    </title>
    <Para>Goran Pocian reported an instance of horrible
      <command>updateclient</command> performance which went away when he
      upgraded from kernel 2.2.17 to 2.2.18.
    </Para>
    <Para>
      Also, he noted that if you mount an NFS filesystem after 
      executing <command>prepareclient</command>, <command>getimage</command>
      will retrieve its contents.  As this can heavily increase network load,
      it can also cause bad performance.
    </Para>
    <Para>Brian Finley reported other possible causes:</Para>
    <BlockQuote>
      <Para>
	Every once in a while, someone reports some mysterious hanging, or
	transfer interruption issue related to rsync.  I had a chance to
	speak with Andrew Tridgell in person today to discuss these issues.
      </Para>
      <Para>
	There are two know issues that could be the source of these symptoms.
	One is a known kernel issue, and one is an rsync issue.  The kernel
	issue is supposedly resolved in 2.4.x series kernels, (SystemImager
	has not yet been "officially" tested with 2.4.x kernels) and may not
	be present in all 2.2.x series kernels (I believe).
      </Para>
      <Para>
	The rsync bug will be fixed in the rsync 2.4.7 release (to happen 
	"Real Soon Now (TM)" ).  The rsync bug is caused by excessive numbers
	of errors filling the error queue which causes a race condition.
	However, until rsync 2.4.7 has been out for some time, I will still
	recommend using v2.4.6 unless you specifically experience one of
	these issues.
      </Para>
      <Para>
	Here's a hack that seems to work for Chris Black.  Add "--bwlimit=10000" 
	right after "rsync" in each rsync command in the &lt;image&gt;.master script.
	<ProgramListing>
	  Change: "rsync -av --numeric-ids $IMAGESERVER::web_server_image_v1/ /a/"
	  To:     "rsync --bwlimit=10000 -av --numeric-ids $IMAGESERVER::web_server_image_v1/ /a/"
	</ProgramListing>
      </Para>
      <Para>
	Here are some tips on diagnosing the problem:
      </Para>
      <ItemizedList>
	<ListItem>
	  <Para>
	    If you get an error message in
	    <Filename>/var/log/messages</Filename> that looks like:
	  </Para>
	  <Para>
	    Jan 23 08:49:42 mybox rsyncd[19347]: transfer interrupted (code 30) at io.c(65)
	  </Para>
	  <Para>
	    You can look up the code number in the
	    <Filename>errcode.h</Filename> file which you can find in the
	    rsync source code.
	  </Para>
	</ListItem>
	<ListItem>
	  <Para>
	    To diagnose the kernel bug:
	    Run <command>netstat -tn</command>.  Here is some sample output
	    (from a properly working system):
	  </Para>
	  <ProgramListing>
  $ netstat -tn
  Active Internet connections (w/o servers)
  Proto Recv-Q Send-Q Local Address           Foreign Address State
  tcp        1      0 192.168.1.149:1094      216.62.20.226:80 CLOSE_WAIT
  tcp        1      0 192.168.1.149:1090      216.62.20.226:80 CLOSE_WAIT
  tcp        1      0 192.168.1.149:1089      216.62.20.226:80 CLOSE_WAIT
  tcp        0      0 127.0.0.1:16001         127.0.0.1:1029 ESTABLISHED
  tcp        0      0 127.0.0.1:1029          127.0.0.1:16001 ESTABLISHED
  tcp        0      0 127.0.0.1:16001         127.0.0.1:1028 ESTABLISHED
  tcp        0      0 127.0.0.1:1028          127.0.0.1:16001 ESTABLISHED
	  </ProgramListing>
	  <Para>The symptoms are:</Para>
	  <ItemizedList>
	    <ListItem>
	      <para>machine A has data in it's Send-Q</para>
	      </ListItem>
	    <ListItem>
	      <para>machine B has no data in it's Recv-Q</para>
	    </ListItem>
	    <ListItem>
	      <para>
		the data in machine A's Send-Q is not being reduced
	      </para>
	    </ListItem>
	  </ItemizedList>
	  
	  <Para>What's happening is:</Para>
	  <OrderedList>
	    <ListItem>
	      <Para>
		one or both kernels aren't honoring the other's
		send/receive window settings (these are dynamically
		calculated)
	      </Para>
	    </ListItem>
	    <ListItem>
	      <Para>
		the result is the kernel(s) aren't getting data from
		machine A to machine B
	      </Para>
	    </ListItem>
	    <ListItem>
	      <Para>
		rsync, therefore, isn't getting data on the receive side
	      </Para>
	    </ListItem>
	    <ListItem><Para>the process appears to hang</Para></ListItem>
	  </OrderedList>
	</ListItem>
	<ListItem>
	  <Para>Details about the rsync bug:</Para>
	  <Para>What happens:</Para>
	  <OrderedList>
	    <ListItem>
	      <Para>
		a large numbers of errors clogs the error pipe between
		the receiver and generator
	      </Para>
	      </ListItem>
	    <ListItem><Para>all progress stops</Para></ListItem>
	    <ListItem>
	      <Para>again, the process appears to hang</Para>
	    </ListItem>
	  </OrderedList>
	</ListItem>
      </ItemizedList>
      <Para>I hope this information helps...</Para>
    </BlockQuote>
    <Para>
      A possible solution, suggested by Robert Berkowitz, is to add
      <option>--bwlimit=10000</option> to the rsync options in the
      rsync initscript.
    </Para>
  </Section>
  <section id=TroubleCDNoBoot>
    <title>
      My autoinstallcd doesn't boot.
    </title>
    <para>
      There was a problem with the following RPM:   
      <filename>syslinux-1.48-1.i386.rpm</filename>
      Download and install a newer syslinux RPM from 
      <ulink url="http://systemimager.org/"></ulink>
    </para>
  </section>
  <section id=TroubleAutoInstallError>
    <title>When making the autoinstalldiskette, my system gives me an error 
      involving "dd" or "mount".</title>
    <para>
      You are using a pre v0.19 version of SystemImager.  Please download
      the latest version from <ulink url="http://systemimager.org/"></ulink>.
    </para>
    <para>
      If you must use a pre v0.19 version for some reason, be sure that your 
      kernel has "ramdisk" support.  Or that you have ramdisk support with a 
      module.  If you are using a module, be sure that it is loaded with the 
      <command>modprobe</command> command.
    </para>
    <para>
      But it's probably easier to just get the latest version...
    </para>
  </section>
  <section id=TroubleAutoinstallFail>
    <title>
      My client failed to autoinstall, and when I run an
      <command>rsync</command> command on it manually it takes forever for
      the image server to respond.</title>
    <para>
      Be sure that the image server can look up the client's hostname based
      on its IP address.  The easiest way to do this is to have entry in the 
      image server's <filename>/etc/hosts</filename> file for the client
      system.
    </para>
  </section>
  <section id=TroubleDHCPFailed>
    <title>
      My autoinstall client booted up and said "dhcp didn't work", but 
      when I do an ifconfig eth0 it has an IP address.
    </title>
    <para>
      Are you using a pre 1.0 version of SystemImager?  If so, please
      upgrade.
    </para>
    <para>
      If for some reason you can't upgrade, then:
    </para>
    <para>
      Are you connected to a switch?  Most switches will wait a period of
      time (usually 30 seconds) after a connected system's interface has
      come up before transmitting on that port. Newer versions of the
      autoinstalldiskette bring the ethernet interface up and wait 45 seconds
      or so before making a DHCP request.  It will then wait 35 seconds or
      so to give the system time to receive an address.  You could be using
      an autoinstalldiskette that does not wait the proper time for your
      switch and is giving up before it should.
    </para>
    <para>
      Be sure that you are using the latest version of SystemImager and
      that you are using the autoinstalldiskette image that comes with that
      version.  Note that the version numbers may not match.  See the 
      <filename>VERSION</filename> file.
    </para>
  </section>
</chapter>
