<chapter>
  <title>Installing SystemImager</title>
  <section>
    <title>How Does it Work?</title>
    <para>
      The concept behind <application>SystemImager</application> is 
      for an image server to retrieve a golden client's entire system image 
      and deploy it to any number of client systems. A golden client is a 
      system you have customized to work exactly the way you want.  You can 
      re-compile the kernel, install custom software, and do any 
      configuration file tweaking you like.
      The <command>getimage</command> command pulls the golden image to the
      image server for deployment to other systems.
    </para>
    <para>
      Once you have deployed the initial image to your client systems,
      you can update/upgrade the client systems by syncing them to an updated
      image on the image server.  Only the modified parts of files are 
      pulled to the client for a fast, efficient, and accurate
      mass update/upgrade.
    </para>
    <note>
      <para>
	Tools other than SystemImager are available for doing automatic
	installations, such as Red Hat's <application>Kickstart</application>, 
	which installs systems based on a list of pre-defined
	packages.  However, such
	package-based installs can be very limiting because they don't
	have an automated way to deal with non-packaged files.  If you
	re-compile your kernel, add a piece of non-packaged software, or
	modify certain configuration files, package-based installation
	methods usually require you to do some sort of scripting or
	programming to deal with these "special cases."
      </para>
    </note>
  </section>
  <section>
    <title>Obtaining SystemImager</title>
    <para>
      SystemImager is currently packaged in .deb, and RPM formats.
      SystemImager is a part of the Debian GNU/Linux 3.0
      distribution, starting with 3.0 (woody).  For earlier releases and
      other distributions, download packages from
      <ulink url="http://systemimager.org">http://systemimager.org/</ulink>.
    </para>
  </section>
  <section>
    <title>Selecting A Machine To Use As An Image Server</title>
    <para>
      Because SystemImager uses other network services such as DHCP, an existing
      server that provides these services often makes a good
      choice for an image server.  In addition, the image server you choose 
      needs to have enough disk space to hold the images you want to deploy.  
      SystemImager stores images as an uncompressed directory structure, so a 
      quick analysis of the disk usage on your golden client will give you a 
      good estimate of the space required on the image server.  If you plan to do 
      multiple simultaneous image updates, poor processor performance on your image
      server can cause a bottleneck.  Keep this in mind when selecting the
      number and speed of processors for your image server.
    </para>
  </section>
  <section>
    <title>Installing an Image Server</title>
    <para>
      To create a SystemImager image server, you must install a systemimager-boot 
	package(s)and then a systemimager-server package that supports your clients.
    </para>
	
    <para>
	The boot packages support multiple configurations.  Because different client 
	configurations require different drivers, kernel
	versions, etc., SystemImager allows you to install different boot packages, which
	are known as "boot flavors."
    </para>

    <para>Each SystemImager release provides the "standard" flavors for each
      supported	architecture.  For example, the 3.0.0 release should have the 
      packages systemimager-boot-i386-standard_3.0.0-1_all.deb,
      systemimager-boot-ia64-standard_3.0.0-1_all.deb,
      systemimager-i386boot-standard.noarch.rpm, and
      systemimager-ia64boot-standard.noarch.rpm</para>

    <para>
	SystemImager and its standard boot flavors support most common hardware configurations.
	The <filename>.config</filename> files list the options for this kernel.
    </para>

    <para>You can use other flavors at any time to support alternate
	client configurations, and mulitple boot flavors can be installed
      simultaneously.  However, boot packages are strongly coupled to the
      version of SystemImager for which they were created.  The SystemImager
      boot package versions strings should match the version
      string of the installed version of SystemImager.
    </para>

    <procedure>
      <title>To install an image server for Debian GNU/Linux 3.0 (woody) and later, run:</title>
      <step>
	<para><command><prompt>#</prompt> apt-get update</command></para>
      </step>
      <step>
	<para>
	  <command>
	    <prompt>#</prompt> apt-get install systemimager-server
	  </command>
	</para>
      </step>
    </procedure>
    <note>
      <para>
	For Debian 2.2 (potato), you must add the following line to the 
	<filename>/etc/apt/sources.list</filename> file:
      </para>
      <para>
	<computeroutput>
	  deb http://systemimager.org/debian / 
	</computeroutput>
      </para>
    </note>
    <procedure>
      <title>For RPM based distributions:</title>
      <step>
	<para>
	  Download and install the systemimager-server RPM and required
	  dependencies from
	  <ulink url="http://systemimager.org/download/">
	    http://systemimager.org/download/
	  </ulink>.
	</para>
      </step>
      <step>
	<para>
	  Install each package with the <command>rpm</command> command.
	</para>
	<para>
	  <command><prompt>#</prompt> rpm -Uvh *.rpm</command>
	</para>
      </step>
    </procedure>
    <formalpara>
      <title>For other distributions:</title>
      <para>
	If your distribution does not support RPMs or .debs, you must use
	build and install from the source tarball; binary tarball
	installations are no longer supported.  Instructions for building
	SystemImager can be found in the <filename>README</filename> file
	within the source tarball.
      </para>
    </formalpara>
  </section>
  <section>
    <title>Selecting A Machine To Use As A Golden Client</title>
    <para>
      A golden client must have similar hardware to the
      machines that will later use its image (i.e. the same network adapter
      chipset and the same storage adapters). You cannot currently deploy a
      SCSI-based image to an IDE based-system (or vice-versa)
      without manually editing the master script and various files
      within the image. The disk size(s) of the golden client can be smaller
      than the other machines that will use its image and larger
      within reason.
    </para>
  </section>
  <section>
    <title>Installing SystemImager Client Software on a Golden Client</title>
    <para>
      To create a golden client, you must install the	systemimager-client
      package.
    </para>
    <procedure>
      <title>For Debian GNU/Linux 3.0 (woody) and later, run:</title>
      <step>
	<para><command><prompt>#</prompt> apt-get update</command></para>
      </step>
      <step>
	<para>
	  <command>
	    <prompt>#</prompt> apt-get install systemimager-client
	  </command>
	</para>
      </step>
    </procedure>
    <note>
      <para>
	For Debian 2.2 (potato), you must add the following line to the file
	<filename>/etc/apt/sources.list</filename>:
      </para>
      <para>
	<computeroutput>
	  deb http://systemimager.org/debian / 
	</computeroutput>
      </para>
    </note>
    <procedure>
      <title>For RPM based distributions:</title>
      <step>
	<para>
	  Download and install the systemimager-client RPM and required
	  dependencies from
	  <ulink url="http://systemimager.org/download/">
	    http://systemimager.org/download/
	  </ulink>.
	</para>
      </step>
      <step>
	<para>
	  Install each package with the <command>rpm</command> command.
	</para>
	<para>
	  <command><prompt>#</prompt> rpm -Uvh *.rpm</command>
	</para>
      </step>
    </procedure>
    <formalpara>
      <title>For other distributions:</title>
      <para>
	If your distribution does not support RPMs or .debs, you must use
	build and install from the source tarball; binary tarball
	installations are no longer supported.  Instructions for building
	SystemImager can be found in the <filename>README</filename> file
	within the source tarball.
      </para>
    </formalpara>
  </section>
  <section>
    <title>Creating an Image on the Golden Client</title>
    <para>
      To create an image for deployment with the SystemImager tool, install
      and configure a Linux distribution and any additional software that you
      want the image to contain on a system you will use as your golden
      client. You will deploy the image of that system (or golden client)
      onto other machines.
    </para>
    <para>
      <application>System Installer</application>, a component of the System 
	Installation Suite to which SystemImager belongs, allows you to install 
	Linux directly to an image, bypassing the golden client step.  <application>System Installer</application> 
	packages and documentation can be found at
      <ulink url="http://systeminstaller.sourceforge.net">
	http://systeminstaller.sourceforge.net
      </ulink>
      Images created with SystemInstaller are interchangeable with those
      created using the SystemImager tools.
    </para>
  </section>
  <section>
    <title>Upgrading SystemImager</title>
    <para>
      SystemImager upgrades are automated in most ways.  However, some parts
      of the upgrade process must be done manually, to prevent losing user
      customizations.
    </para>
    <section>
      <title>Regenerating autoinstallscripts</title>
      <para>
        The autoinstall scripts, stored in /var/lib/systemimager/scripts, must
        be updated with each release of SystemImager.  Otherwise, installations
        using older scripts may fail.  This can easily be accomplished using
        the <command>mkautoinstallscript</command> command.
      </para>
      <warning>
        <para>
          <command>mkautoinstallscript</command> will overwrite the 
          pre-existing script for an image.  If you have made any changes to 
          your autoinstall scripts (also known as .master scripts), you should 
          backup those scripts in order to forward port your changes to the new
          release.
        </para>
      </warning>
      <example>
        <title>Generating new autoinstallscripts</title>
        <para>
          # /usr/sbin/mkautoinstallscript -image myimage -post-install reboot -ip-assignment dhcp
        </para>
        <para>
          If you require customizations to your autoinstallscript, edit the 
          appropriate .master file in /var/lib/systemimager/scripts/
        </para>
      </example>
    </section>
    <section>
      <title>Customizations to /etc/systemimager/rsyncd.conf</title>
      <para>
        Prior to the 3.0.0 release, your changes to 
        <filename>/etc/systemimager/rsyncd.conf</filename> could
        be made in place, but were susceptible to upgrade issues.  As of
        3.0.0, these changes can be made in a separate file, that is maintained
        across upgrades.  For details, see the mkrsyncd_conf(8) man page.
        The rpm/deb package upgrades should take care of this process for you,
        but you may want to look through the /etc/systemimager/rsync_stubs
        directory to make sure you get the desired results.
      </para>
    </section>
    <section>
      <title>Regenerating boot media</title>
      <para>
        Each time you upgrade systemimager, you should also upgrade the boot
	media you use to boot the autoinstall system.  Use mkautoinstallcd or
	mkautoinstalldiskette to regenerate removable media.  If you network
	boot, make sure you update the files in your /tftpboot directory, and
	also be sure that you are passing all necessary options to the kernel.
	These options occasionally change - check 
	/etc/systemimager/pxelinux.cfg/syslinux.cfg for examples.
      </para>
    </section>
    <section>
      <title>What happened to the binary tarballs?</title>
      <para>
        With the 3.0.0 release, we deprecated the binary tarball releases.
        3.0.0 introduced the boot packages feature, which requires that various
        components of the SystemImager system have some sort of version 
        control.  As this would've required a significant effort without 
        relying on a package management system, it was decided that not 
        supporting unpackaged bits was the better solution.
      </para>
      <para>
        However, now that we have a build system based on make, you can do
        things like 'make install_server_all', etc.  This is now the preferred
        method for installing w/o using a package manager.  You will need to
        track down all build dependencies and runtime dependencies by hand, but
        considering you don't use a package manager, you're used to that 
        anyway, right?
      </para>
    </section>
  </section>
</chapter>
