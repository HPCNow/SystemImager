<!-- 
  $Id$
-->

<chapter>
 <title>FAQ (Frequently Asked Questions)</title>
 <qandaset defaultlabel='qanda'>

  <qandaentry>
   <question><para>Where are the images stored?</para></question>
   <answer>
    <para>
     The images are stored in <filename>/var/lib/systemimager/images</filename>.
    </para>
    <note>
     <para>
      NOTE: If you are short on disk space in this location, move the
      directory to another location:
     </para>
    </note>
    <para>
     <command>
      mv /var/lib/systemimager/images /home/systemimager_images
     </command>
    </para>
    <para>
     Then create a soft link to the new directory.
    </para>
    <para>
     <command>
      ln -s /home/systemimager_images /var/lib/systemimager/images
     </command>
    </para>
   </answer>
  </qandaentry>
 
  <qandaentry>
   <question>
    <para>How do I make an autoinstall diskette?</para>
   </question>
   <answer>
    <para>
     Run the <command>si_mkautoinstalldiskette</command> command on the 
     image server.
    </para>
   </answer>
  </qandaentry>
 
  <qandaentry>
   <question><para>How do I make an autoinstall CD?</para></question>
   <answer>
    <para>
     Run the <command>si_mkautoinstallcd</command> command on the image server.
    </para>
   </answer>
  </qandaentry>
 
  <qandaentry>
   <question>
    <para>How do I make an autoinstall punch card?</para>
   </question>
   <answer>
    <para>
     Run the <command>si_mkautoinstallpunchcard</command> command on the
     image server - deprecated :)
    </para>
   </answer>
  </qandaentry>

  <qandaentry>
   <question>
    <para>
     How does the autoinstall client software know where to get the image?
    </para>
   </question>
   <answer>
    <para>
     When the autoinstall client software (BOEL) is booted, if the LAST_ROOT 
     append parameter has been used, then BOEL attempts to mount and read a 
     local.cfg file from the device specified in LAST_ROOT (Aka: the device 
     that was root on the machine before it was rebooted).  BOEL then tries to
     read a local.cfg file from the floppy drive (if one exists).  Finally, BOEL
     makes a DHCP request, if it still doesn't have enough information to
     connect to the network.  Once it knows it's IP address, it resolves this to
     it's host name, then retrieves an autoinstall script from the image server
     based on it's hostname (Ie: hostname.sh).
    </para>
   </answer>
  </qandaentry>

  <qandaentry>
   <question>
    <para>
     How does the netboot system know where to get the image?
    </para>
   </question>
   <answer>
    <para>
     See "How does the autoinstall client software know where to get the image?"
    </para>
   </answer>
  </qandaentry>
 
  <qandaentry>
   <question>
    <para>
     How do I edit files on the initial ramdisk?
    </para>
   </question>
   <answer>
    <para>
     In SystemImager 3.0.x, the initial ramdisk is a cramfs filesystem.
     The following example shows you how to open it, edit a file, and 
     create a new ramdisk.  You might want to edit this file if you want
     to change things in the process prior to the execution of the .master
     script.
    </para>
    <orderedlist>
     <listitem>
      <para>gunzip &lt; initrd.img &gt; /tmp/initrd</para>
     </listitem>
     <listitem>
      <para>mkdir /mnt/tmp</para>
     </listitem>
     <listitem>
      <para>mount /tmp/initrd /mnt/tmp -o loop</para>
     </listitem>
     <listitem>
      <para>mkdir /tmp/initrd.new</para>
     </listitem>
     <listitem>
      <para>cp -a /mnt/tmp/* /tmp/initrd.new</para>
     </listitem>
     <listitem>
      <para>umount /mnt/tmp</para>
     </listitem>
     <listitem>
      <para>cd /tmp/initrd.new</para>
     </listitem>
     <listitem>
      <para>make your edits here - vi etc/init.d/rcS, for example</para>
     </listitem>
     <listitem>
      <para>mkcramfs /tmp/initrd.new /tmp/newinitrd</para>
     </listitem>
     <listitem>
      <para>gzip -9 &lt; /tmp/newinitrd &gt; /tmp/initrd.img</para>
     </listitem>
    </orderedlist>
   </answer>
  </qandaentry>

  <qandaentry>
   <question>
    <para>
     When I pass options from dhcp (option-100, etc), the client appears
     to get and try to use a hexadecimal number instead.  How do I make it
     pass a dotted-quad IP address instead?
    </para>
   </question>
   <answer>
    <para>
     The hexadecimal address is actually the hexadecimal representation of
     your IP address (you can verify this with the gethostip command).
     This is normally a quoting issue.  Add quotes around the IP address
     in the configuration file.
    </para>
   </answer>
  </qandaentry>
  <qandaentry>
   <question>
    <para>
     I've got si_netbootmond running, but it isn't working.  Why?
    </para>
   </question>
   <answer>
    <para>
     In order for si_netbootmond to do it's thang, you must have the rsync
     daemon running: "/etc/init.d/systemimager-server-rsyncd start".
    </para>
   </answer>
  </qandaentry>
     
  <qandaentry>
   <question>
    <para>
     How do I configure my server to net boot ia64 clients?
    </para>
   </question>
   <answer>
    <orderedlist>
     <listitem>
      <para>Install tftp (tftp-hpa >= 0.28 is recommended) on your boot server.
      </para>
     </listitem>
     <listitem>
      <para>
        Configure inetd or xinetd to enable tftp.
      </para>
       <itemizedlist>
        <listitem>
         <para>
          To configure inetd, find the tftp entry in 
          <filename>/etc/inetd.conf</filename> and change it to: 
         </para>
         <para>
tftp            dgram   udp     wait    root    /usr/sbin/in.tftpd -v -v -v -s /tftpboot
         </para>
         <para>
          Change "/usr/sbin/in.tftpd" to be the full path to your tftp server,
          if you installed it in a different directory.
         </para>
         <para>
          The -v's aren't strictly required but make the tftp server
          more verbose, which makes it easier to diagnose problems.
         </para>
         <para>
          Finally, send a HUP signal to inetd (this causes it to reload its
          configuration file).  # killall -HUP inetd
         </para>
        </listitem>
        <listitem>
         <para>
          To configure xinetd, change:
         </para>
         <programlisting>
   service tftp
{
        socket_type             = dgram
        protocol                = udp
        wait                    = yes
        user                    = root
        server                  = /usr/sbin/in.tftpd
        server_args             = -s /home/tftp
        disable                 = no
}
         </programlisting>
         <para>to:</para>
         <programlisting>
service tftp
{
        socket_type             = dgram
        protocol                = udp
        wait                    = yes
        user                    = root
        server                  = /usr/sbin/in.tftpd
        server_args             = -s /tftpboot -r blksize
        disable                 = no
}
         </programlisting>
         <para>
          Finally, send a USR2 signal to xinetd (this causes it to reload its
          configuration file).
         </para>
        </listitem>
       </itemizedlist>
      </listitem>
      <listitem>
       <para>
        Configure your DHCP server so that it provides boot 
        information to the client. Be careful when setting up your DHCP 
        server - if it is set to hand out dynamic addresses and is located on 
        a public subnet, it may give bogus information to other machines on the
        network, possibly destroying data on those machines. It is recommended 
        that you use a private subnet for doing network installs. If possible, you should 
	  also configure your DHCP server to only answer requests
        from known hosts based on the MAC address.
       </para>
       <para>
        Add an entry for the boot client in /etc/dhcpd.conf
       </para>
       <programlisting>
host mcmuffin {
        hardware ethernet 00:30:6e:1e:0e:83;
        fixed-address 10.0.0.21;
        filename "elilo.efi";
}
       </programlisting>
      </listitem>
      <listitem>
       <para>
        Copy elilo.efi from an IA-64 machine to your tftpboot directory and make them
        world readable.  This file is usually found in a subdirectory under /boot/efi or
        in /usr/lib/elilo.  It can also be found in the elilo package in IA64
        distributions.
       </para>
       <para>
        You also must create an elilo.conf file in your tftpboot directory.
        A sample one is provided in /usr/share/doc/systemimager-doc/examples, or you
        can type in the one below.
       </para>
      </listitem>
      <listitem>
       <para>
        Edit /tftpboot/elilo.conf:
       </para> 
       <programlisting>
#
# Sample elilo.conf for netbooting ia64 systemimager clients
#
# Inside your tftp directory you may also want to do this:
#
#   mkdir -p ia64/standard
#   cp /usr/share/systemimager/boot/ia64/standard/* ia64/standard/
#
default=systemimager
 
image=ia64/standard/kernel
    label=systemimager
    initrd=ia64/standard/initrd.img
    root=/dev/ram
    append="vga=extended ramdisk_blocksize=4096 console=tty0"
    #
    # Uncomment APPEND line below, and comment out APPEND line above, to use
    # both monitor (tty0) and first serial port (ttyS0) as console at the
    # same time.
    #
    # NOTE: Be sure your serial port speed is appropriate (57600, 9600, etc.)
    #
    #append="vga=extended ramdisk_blocksize=4096 console=tty0 console=ttyS0,9600n8"
    read-only
       </programlisting>
       <para>
        If ABCDEFGH is the client's IP address in hex, elilo.efi will use the 
        first one of the following files that it finds as its configuration
        file:
       </para>
       <itemizedlist>
        <listitem><para>ABCDEFGH.conf</para></listitem>
        <listitem><para>ABCDEFG.conf</para></listitem>
        <listitem><para>ABCDEF.conf</para></listitem>
        <listitem><para>...</para></listitem>
        <listitem><para>A.conf</para></listitem>
        <listitem><para>elilo.conf</para></listitem>
       </itemizedlist>
       <para>
        You can use the ipcalc utility, which is available in the syslinux
        package, to calculate the hex representation of an IP address in
        dotted quad form.
       </para>
      </listitem>
      <listitem>
       <para>
        Configure the client to support TFTP booting.
       </para>
       <orderedlist>
        <listitem><para>Boot to EFI</para></listitem>
        <listitem>
         <para>Enter the Boot option maintenance menu</para>
        </listitem>
        <listitem><para>Add a boot option</para></listitem>
        <listitem>
         <para>
          Press return on the line saying "Load file [Acpi/.../Mac()]"
         </para>
        </listitem>
        <listitem>
         <para>
          Call the entry Netboot or something similar
         </para>
        </listitem>
        <listitem> 
         <para>
          Save and exit, Netboot is now available in the boot menu.
         </para>
        </listitem>
       </orderedlist>
      </listitem>
     </orderedlist>
    </answer>
  </qandaentry>

  <qandaentry>
   <question>
    <para>
     How do I set up my autoinstall clients so that the console is
     available via the serial port?
    </para>
   </question>
   <answer>
    <para>
    	<command>In SystemImager 2.1 and later, si_mkautoinstallcd</command> and <command>si_mkautoinstalldiskette</command>
    	support an -append option, allowing you to specify additional options for the autoinstall kernel,
    	including serial console options.  For example:  
    	<command>si_mkautoinstallcd -out-file autoinstall.iso -append "console=ttyS0"</command>
    </para>
    <para>
    	Early versions of SystemImager require additional changes, as cited below:
    </para>
    <BlockQuote>
     <LiteralLayout>
      Making SystemImager work with a serial console
      Michael S. Fischer, &lt;michael@auctionwatch.com&gt;
      Last modified: 01/04/26 19:20:27
      
      The current version of SystemImager as of this writing (1.4.1)
      does not support PXE booting of clients with serial console
      support.  This document describes how to rebuild the kernel and
      initrd such that serial console support is possible.
      
      Step 1: Download the sources
      
      Retrieve the source tarball from
      http://prdownloads.sourceforge.net/systemimager/va-systemimager-source-1.4.1.tar.bz2
      Save it and unpack it to /tmp on your boot server.
      
      # bzcat va-systemimager-source-1.4.1.tar.bz2 | tar -C /tmp -xf -
      
      
      Step 2: Prepare the kernel
      
      # cd /tmp/va-systemimager-source-1.4.1
      # bzcat other_source_and_patches_used_in_this_release.tar.bz2 | tar xf -
      # cd other_source_and_patches_used_in_this_release
      # cd linux-2.2.18+reiserfs+raid+aic7xxx+VM
      
      Now edit the .config file in this directory.  Search for a line
      that reads:
      
      # CONFIG_SERIAL is not set
      
      Change this line to read:
      
      CONFIG_SERIAL=y
      CONFIG_SERIAL_CONSOLE=y
      
      Then build the kernel:
      
      # make clean && make bzImage
      
      
      Step 3: Install the kernel
      
      Next, you'll need to place the kernel in /tftpboot and
      /tftpboot/X86PC/UNDI/linux-install:
      
      # cp arch/i386/boot/bzImage /tftpboot/kernel
      # cp arch/i386/boot/bzImage /tftpboot/X86PC/UNDI/linux-install/kernel
      
      
      Step 4: Fix the initrd
      
      The initrd, or initial RAM disk containing the root filesystem, needs
      to be unpacked, mounted, and have its contents edited as follows:
      
      # cp /tftpboot/initrd.gz /tmp
      # cd /tmp && gunzip initrd.gz
      # mkdir /mnt2
      # mount /tmp/initrd /mnt2 -o loop
      # cd /mnt2/dev
      # rm -f console
      # mknod -m 622 console c 5 1
      # mknod -m 600 ttyS0 c 4 64
      
      You should now unmount the initrd, recompress
      it, and return it to /tftpboot:
      
      # cd /tmp
      # umount /mnt2
      # gzip -9 initrd
      # cp initrd.gz /tftpboot
      # cp initrd.gz /tftpboot/X86PC/UNDI/linux-install
      
      
      Step 5: Edit syslinux.cfg
      
      The final step is to configure pxelinux to pass the "console="
      arguments to the kernel.  Following is a suitable syslinux.cfg
      file:
      
      DEFAULT kernel
      APPEND console=tty0 console=ttyS0,9600n8 vga=extended load_ramdisk=1
      prompt_ramdisk=0 initrd=initrd.gz root=/dev/ram rw
      DISPLAY message.txt
      PROMPT 1
      TIMEOUT 50
      
      Edit the contents of /tftpboot/pxelinux.cfg/syslinux.cfg to reflect
      the changes above.  Then, copy this file to
      /tftpboot/X86PC/UNDI/linux-install/pxelinux.cfg/syslinux.cfg.
     </LiteralLayout>
    </BlockQuote>
   </answer>
  </qandaentry>
      
  <qandaentry>
   <question>
    <para>
      Why do installations take so much longer when done
      using a serial console and --listing?
    </para>
      </question>
      <answer>
        <para>
	  The serial console itself often causes the bottleneck.  If you
          have a slow console never use --listing option with:
          <command>si_getimage</command>,
          <command>si_mkautoinstallscript</command>.

          By default each filename is not printed to the console as it is
          copied from the server.
        </para>
      </answer>
  </qandaentry>
 
  <qandaentry>
   <question>
    <para>
      How can I change the mount options used for the tmpfs filesystem used by
      BOEL during an autoinstall?
    </para>
      </question>
      <answer>
        <para>
	  tmpfs filesystem mount options can be passed to the BOEL kernel as 
	  append parameters by pre-pending "tmpfs_" to the mount
	  option.  For example, adding "tmpfs_size=2G tmpfs_nr_inodes=2000" is
	  translated by BOEL to the tmpfs mount options 
	  "size=2G,nr_inodes=2000".  The following tmpfs mount
	  options are supported: size, nr_inodes, nr_blocks, and mode.  See 
	  "man mount" for details on these options.
        </para>
        <para>
	  Append parameters can be added with the si_mkautoinstallcd and 
	  si_mkautoinstalldiskette --append option.  For network boot loaders, or
	  local disk boot loaders, you will need to edit the boot configuration
	  file to add the appropriate append parameter(s).
        </para>
      </answer>
  </qandaentry>
 
  <qandaentry>
    <question>
      <para>How do I configure my DHCP v3 server?</para>
    </question>
    <answer>
      <para>
        Luca Filipozzi provided details on configuring DHCP v3 servers:
      </para>
      <para>
        If you are using DHCP v3 from ISC, you will need to use
        the following configuration directives to make use of
        option 140:
      </para>
      <para>
        option systemimager-server code 140 = text;
        option systemimager-server "192.168.1.1";
      </para>
      <para>
        The first line defines 'systemimager-server' as the
        name for option 140 and that it shall take as an
        argument a text string. The second line assigns a
        value (an IP address) to the name. 
      </para>
    </answer>
  </qandaentry>
 
  <qandaentry>
    <question>
      <para>Does the DHCP server have to be on the image server?</para>
    </question>
    <answer>
      <para>
        No.  If you are using DHCP, you can use "option-140" and set its
        value to the IP address of the image server.  If you use
        <command>si_mkdhcpstatic</command> to configure your
        <filename>dhcpd.conf</filename>
        file, it will ask you for the IP address of your image server and
        add the appropriate entry for you.
      </para>
      <para>
        Because this is not the official use for option-140, work is being
        done to either get an official number assigned or use a number from
        the private number range.
      </para>
    </answer>
  </qandaentry>
 
  <qandaentry>
   <question><para>With which distributions does SystemImager work?</para></question>
   <answer>
    <para>
     SystemImager is designed to work with _any_ distribution.  Post imaging
     configuration is handled by System Configurator, which uses a "footprinting" 
     technique to identify the style of system configuration files used, and to
     configure networking, boot, and similar information accordingly.  If you find
     a distribution that SystemImager does not work with, please file a bug report.
    </para>
   </answer>
  </qandaentry>
 
    <qandaentry>
      <question>
	<para>
	  How do I add a driver for a special card to the autoinstall kernel?
	</para>
      </question>
      <answer>
	<para>
	  If you have hardware that requires a driver that was not included
	  in the standard flavor boot package, you can build a custom boot
	  package.  Unlike earlier (pre-2.9) releases, you will need more than
	  a new kernel binary.  However, also unlike earlier releases, you can
	  have multiple boot packages installed simultaneously on your system.
	</para>
	<para>
	  The following instructions describe how to create a new boot package.
	  Use these steps to add a network driver or block device driver 
	  that can either be a module or statically linked:
        </para>
	<warning>
	  <para>
	    Boot packages are tightly linked to the version of SystemImager
	    you are using.  If you make customizations to a boot package
	    for SystemImager 3.0.0, you must forward port
	    those changes when you move to SystemImager 3.2.0.
	  </para>
	</warning>
	<formalpara>
	  <title>Creating a custom boot package</title>
	  <para>
	    If the driver you need to add can be built as a module,
	    you can add it directly onto the autoinstall ramdisk.
	    Use this method if you need to add a driver for the network interface 
	    you plan to install over and the driver is only available as a module.  
	    This is also the suggested method for adding a module for a device
	    that failed to be discovered at install time.  In other cases, 
	    you can drop in a patch to be added to the kernel build tree or
	    make modifications to the <filename>.config</filename> file used to build the kernel.
	  </para>
	</formalpara>
	<orderedlist>
	  <listitem>
	    <para>
	      Download the source tarball for the release of SystemImager
	      you are using from http://systemimager.org/.
	    </para>
	  </listitem>
	  <listitem>
	    <para>
	      Extract the source tarball and cd into the top level of the
	      source tree.
	    </para>
	    <informalexample>
	      <programlisting>
		# tar xvfj systemimager-3.0.0.tar.bz2
		# cd systemimager-3.0.0
	      </programlisting>
	    </informalexample>
	  </listitem>
	  <listitem>
	    <para>
	      To add a patch to the kernel, drop your patch file in the patches subdirectory of the
	      top level build tree.  Follow the naming convention described in the README.patches file in
	      the patches/ subdirectory.
	    </para>
	  </listitem>
	  <listitem>
	    <para>
	      If you need to modify the .config file for your kernel (e.g.
	      to turn on a driver), you can find it in the patch
	      directory named linux.&lt;arch&gt;.config.  (If you added
	      a patch that includes a new driver, you should be prompted
	      to turn that on in Step 9 of these instructions - the 'make binaries' step).
	    </para>
	  </listitem>
	  <listitem>
	    <para>
	      If you are building a binary module from external source to be 
	      included in the autoinstall ramdisk, you need the linux
	      source tree to build against.  You can generate a source tree 
	      in the src/linux directory by
	      running <command>make patched_kernel-stamp</command>.  
		Follow the instructions that came with your module
	      source to compile your module against this tree.
	    </para>
	  </listitem>
	  <listitem>
	    <para>
	      If you created a binary module, you can copy it into the 
	     	initrd_source/my_modules directory. Add instructions to the 
	      <filename>INSMOD_COMMANDS</filename> file in order to have
	      your module loaded at install time.  See comments in that file 
		for details.
	    </para>
	  </listitem>
	  <listitem>
	    <para>
	      Edit the <filename>FLAVOR</filename> file in the
	      top level of the source tree.  Choose an alphanumeric
	      string that describes your modifications.
	    </para>
	    <informalexample>
	      <programlisting>
		echo "mygigabitnic" &gt; FLAVOR
	      </programlisting>
	    </informalexample>
	  </listitem>
	  <listitem>
	    <para>
	      From the toplevel of the source tree, run <command>make binaries</command>.
	      See the README file for details on building prerequisites.
	    </para>
	  </listitem>
	  <listitem>
	    <para>
	      Run <command>make install_binaries</command> to copy the binaries
	      built in the previous step into the appropriate place in
	      /usr/share/systemimager/boot directory.  You now
	      have an additional flavor to choose from when creating
	      autoinstall media.
	    </para>
	  </listitem>
	  <listitem>
	    <para>
	      File a bug asking for this driver to be added to future
	      releases.
	    </para>
	  </listitem>
	</orderedlist>
      </answer>
    </qandaentry>
    	
  <qandaentry>
    <question>
      <para>
        Do I have to do anything to prepare a client from which I will get 
        an image?
      </para>
    </question>
    <answer>
      <para>
        Yes, you should install the systemimager-client package.  If this
        package is already installed, simply run the
        <command>si_prepareclient</command> command prior to running
        <command>si_getimage</command> from the image server.
      </para>
      <para>
        You should also add any software, configure any files, and do
        any tweaking to customize the system to your specifications.
      </para>
    </answer>
  </qandaentry>
  <qandaentry>
    <question>
      <para>
        Can I use the autoinstalldiskette or autoinstallcd on more than one
        machine?
      </para>
    </question>
    <answer>
      <para>
        Yes.  The autoinstall media is generic and can be on any machine
        you want to autoinstall.
      </para>
    </answer>
  </qandaentry>

  <qandaentry>
    <question><para>How do I push an image to a client?</para></question>
    <answer>
      <para>
        Starting with version 1.5, you can use the
        <command>si_pushupdate</command> command, which essentially logs into
        each client and executes the <command>si_updateclient</command>
        command.
      </para
    </answer>
  </qandaentry>

  <qandaentry>
    <question>
    <para>How do I pull an image to a client?</para>
    </question>
    <answer>
      <para>
        If you ran <command>si_mkdhcpserver</command> to configure your dhcp 
        information, and if you answered all the questions you were asked
        when you did ran <command>si_getimage</command>, including the
        hostnames and IP addresses, then all you have to do is boot your
        client with any one of the following three forms of autoinstall
        media:  
      </para>
      <orderedlist>
        <listitem>
          <para>
    	<emphasis>autoinstalldiskette</emphasis> - takes longer to
             boot, and floppies are often quite volatile
          </para>
        </listitem>
        <listitem>
          <para>
    	<emphasis>autoinstallcd</emphasis> - takes slightly less time
    	to boot and is more durable, but you have to have a CD burner
    	and clients that can read CD-R's)
          </para>
        </listitem>
        <listitem>
          <para>
    	<emphasis>network boot</emphasis> - boot time is dramatically,
    	 but this method requires PXE capable network cards in the
             clients and additional server-side configuration.
          </para>
        </listitem>
      </orderedlist>
      <para>
        See the entries for <command>si_mkautoinstallcd</command> and 
        <command>si_mkautoinstalldiskette</command> in the command
	  reference chapter in this manual for more information.
      </para>
    </answer>
  </qandaentry>

  <qandaentry>
    <question>
      <para>
        How does an autoinstall client know which image to install?
      </para>
    </question>
    <answer>
      <para>
        In order to better understand the answer, begin by reading
        the steps the autoinstall client goes through:
      </para>
      <orderedlist>
        <listitem>
          <para>
    	Boots off the autoinstallmedia
          </para>
        </listitem>
        <listitem>
          <para>
    	Gets an IP address from DHCP
          </para>
        </listitem>
        <listitem>
          <para>
    	Determines the IP address of the image server via DHCP
          </para>
        </listitem>
        <listitem>
          <para>
    	Requests a hosts file from the image server
          </para>
        </listitem>
        <listitem>
          <para>
    	Finds its hostname in the hosts file based on its IP address
          </para>
        </listitem>
        <listitem>
          <para>
    	Requests a script from the image server based on its hostname
    	(for example: <filename>www237.sh</filename>)
          </para>
        </listitem>
        <listitem>
          <para>
    	Executes this script.
          </para>
        </listitem>
      </orderedlist>
      <para>
        The script in question is typically a soft link pointing at the 
        <filename>$image.master</filename> script that was dynamically
        created when you ran <command>si_getimage</command>.  This script
        explicitly states which image to pull from the image server.  Open
        it and take a look.
      </para>
      <para>
        These scripts and the <filename>$image.master</filename> script can
        be found in <filename>/var/lib/systemimager/scripts</filename>.
      </para>
    </answer>
  </qandaentry>

  <qandaentry>
    <question>
      <para>How do I upgrade to a new version of SystemImager?</para>
    </question>
    <answer>
      <para>
        If you have SystemImager 1.0 or later, you can simply 
        install the new version over the older one.  Using a packaged
        version (.rpm,.deb) is recommended to prevent cruft build-up on
        your system.
      </para>
      <para>
        If you have a pre-1.0 version then you can't simply
        install a new version on top of it.  Depending on the
        version changes, the following may work for you, but it is not
        guaranteed.  If you want to try this method, please check with the
        <filename>CHANGE.LOG</filename> document to find out what has
        changed.
      </para>
      <para>
        Move your images directory
        out of the SystemImager directory hierarchy and back up your 
        <filename>/etc/rsyncd.conf</filename> file and any other
        configuration files you may have changed.  Then install
        SystemImager as if you were installing it for the first time, after
        which you can move your images directory and
        <filename>/etc/rsyncd.conf</filename> file back.
      </para>
    </answer>
  </qandaentry>

  <qandaentry>
    <question>
      <para>What if I want to assign static IPs to my clients?</para>
    </question>
    <answer>
      <para>
        You can. <command>si_getimage</command> will ask you if you want to
        assign static IPs.
      </para>
    </answer>
  </qandaentry>

  <qandaentry>
    <question>
      <para>
        I want to use DHCP to assign static IPs to my clients, but I don't 
        want to have to enter my 1000 mac addresses manually.  What can I
        do?
      </para>
    </question>
    <answer>
      <para>
        SystemImager comes with the <command>si_mkdhcpstatic</command>
        utility.  As you boot your client systems, the DHCP server will
        assign addresses sequentially.  By initially booting your systems
        in the order you want them to receive their IP addresses, you can
        ensure that they get the IP address you want them to have.  
      </para>
      <para>
        After booting your systems, run <command>si_mkdhcpstatic</command>.
        It will re-write your <filename>/etc/dhcpd.conf</filename> file,
        associating each client's MAC address with its host name.  You
        should then restart your dhcpd daemon.  Subsequently, each time
        your clients request an IP address via DHCP, they will always be
        assigned their appropriate static IP address.
      </para>
      <para>
        Note:  The client's hostname is used, instead of an explicit IP
        address, so that you simply have to change the
        <filename>hosts</filename> file on the DHCP server (or DNS, NIS,
        etc.) to change the IP address that that client recieves.
      </para>
      <para>
        Note:  Assigning static IP addresses by DHCP is the author's
        preferred method for administering IP on a large number of systems.
      </para>
    </answer>
  </qandaentry>

  <qandaentry>
    <question>
      <para>What kind of performance can I expect?</para>
    </question>
    <answer>
      <para>
       Ole Holm Nielsen, Department of Physics, Technical University of Denmark reports:
      </para>

      <para>
       In our SystemImager installation, we can install 18 clients 
       simultaneously with 1.8 GB images in 6 minutes.  Please see 
       <ulink url="http://www.fysik.dtu.dk/CAMP/Niflheim/systemimager.html">The NIFLHEIM SystemImager Page</ulink>.
       Our server has Gigabit network, 2 GB of RAM, dual Intel Xeon 2.4 GHz,
       whereas the clients have Intel P4 and 100 Mbit Ethernet.
      </para>
      <para>
       James Braid reports:
      </para>
      <para>
       From a Celeron 700/512Mb server over 100Mbit ethernet, we manage to do a ~1Gb
       image in about 7 - 10 min.  The disks are 5x 120Gb Seagate Barracuda V in one 
       LVM set (non striped), with a ReiserFS filesystem.
      </para>
    </answer>
  </qandaentry>

  <qandaentry>
    <question>
      <para>How do I update an image on the image server?</para>
    </question>
    <answer>
      <para>
        There are two ways to update an image on the image server:
      </para>
      <orderedlist>
        <listitem>
          <para>
    	Make the changes to one of your clients and run the 
    	<command>si_getimage</command> again.  
          </para>
          <para>
    	- You can specify the same image name, in which case the
    	current image will be updated (only changes are pulled across).
          </para>
          <para>
    	- Or you can specify a new image name and have a form of
    	revision control.  (This method is highly recommended)
          </para>
          <para>
    	Note:  Every time <command>si_getimage</command> is run, it 
    	recreates the <filename>$image.master</filename> script.  If
            you
    	have customized your <filename>$image.master</filename> script,
    	be sure to save it before running <command>si_getimage</command>
    	again.
          </para>
        </listitem>
 
        <listitem>
          <para>
    	Modify the files directly.  You can simply cd into the
    	appropriate image directory and edit the files there, or
    	(recommended) you can <command>cd </command>into the image
    	directory and run <command>'chroot . sh'</command>.  This will
    	change your working root directory to the root of the image you
    	want to manipulate.  You can then run <command>rpm</command>
    	and other commands on the image and not have to worry
    	about getting confused and damaging the image server.  When you
    	are done, simply type <command>exit</command> and you will be
    	returned to your normal shell.
          </para>
        </listitem>
      </orderedlist>
    </answer>
  </qandaentry>

  <qandaentry>
    <question>
      <para>How do I update a client to match an image?</para>
    </question>
    <answer>
      <para>
        Once you have updated an image on the image server, you can then
        update your clients to reflect it.  (You do not need
        to do a complete re-autoinstall.)  You will find the
        command, <command>si_updateclient</command>, on your clients, which
        takes as its parameters the name of the image server and
        the name of the image you want to update the client to.  Run
        <command>si_updateclient -help</command> to get more information about
        this command.
      </para>
      <para>
        Use the revision control method recommended in the "How do I
        update an image on the image server?" FAQ to
        bring your production environment back to a known state after
        doing an <command>si_updateclient</command> to a test image (i.e. do
        an <command>si_updateclient</command> to the last working image).
      </para>
      <para>
        The file
        <filename>/etc/systemimager/updateclient.local.exclude</filename>
        on your clients is used to exclude files and directories from
        being updated by the <command>si_updateclient</command> command.
        You can modify it to suit your own environment.
      </para>
    </answer>
  </qandaentry>

  <qandaentry>
    <question>
      <para>
        What is the <filename>updateclient.local.exclude</filename> file
        used for?
      </para>
    </question>
    <answer>
      <para>
        It is used by the <command>si_updateclient</command> command.  See the
        "How do I update a client to match an image?," FAQ for more 
        information.
      </para>
    </answer>
  </qandaentry>

  <qandaentry>
    <question>
      <para>How do I build a new "front-end" server?</para>
    </question>
    <answer>
      <para>
        Another way of stating the question is as
        follows, "We are in the process of building a new 'front-end'
        server for our Linux cluster.  We'd like to try using SystemImager
        as our node cloning software if possible.
      </para>
      <para>
        I've read through the SystemImager FAQ and found the following:
        <blockquote> 
          <para>
    	All of the clients for a particular image should have an
    	identical hardware configuration.  They should at least have
    	the same hard drive(s) and the same ethernet card(s).
          </para>
        </blockquote> 
      </para>
      <para>
        This is a problem because our front-end from which the image will be
        captured has a SCSI hard drive and a Gigabit ethernet card.
        On the other hand, our 64 compute nodes have IDE disk drives and
        fast ethernet cards.  Is it impossible to build a new "front-end" server?
      </para>
      <para>
        No.  But you will need to customize a bit.
      </para>
      <para>
        Once you have run <command>si_getimage</command>, you will need
        to edit the <filename>conf.modules</filename> in the image on the
        image server to load the appropriate module for your ethernet card.
      </para>
      <para>
        <command>
          vi /var/lib/systemimager/images/$imagename/etc/conf.modules
        </command>
      </para>
      <para>
        Your entry should look like this:
      </para>
      <para>
        <programlisting>
          alias eth0 tulip
        </programlisting>
      </para>
      <para>
        You will need to edit the following files in your image:
      </para>
    <para>
        <programlisting>
          <filename>/var/lib/systemimager/images/$imagename/etc/fstab</filename>
          <filename>/var/lib/systemimager/scripts/$imagename.master</filename>
          <filename>/var/lib/systemimager/images/$imagename/etc/lilo.conf</filename>
        </programlisting>
      </para>
 
    <para>
        Use your editor's search function to change every instance of "sda" to "hda."
      </para>
      <para>
        Proceed as normal.
      </para>
    </answer>
  </qandaentry>
 
  <qandaentry>
     <question>
       <para>
         How can I use SystemImager to update a small set of files? For 
         instance, I apply a security patch and I want all boxes to reflect 
         that change.
       </para>
     </question>
     <answer>
       <para>
         Use the <command>si_updateclient</command>
         command on the client.
       </para>
       <para>
         <orderedlist>
           <listitem>
     	<para>
     	  Choose one of the following methods to update the image on
     	  the server:
     	  <orderedlist>
     	    <listitem>
     	      <para>
     		apply the patch to the image directly
     	      </para>
     	    </listitem>
     	    <listitem>
     	      <para>
     		apply the patch to a client and then do another
     		<command>si_getimage</command> specifying the same imagename (won't take long
     		and will update the image)
     	      </para>
     	    </listitem>
     	    <listitem>
     	      <para>
     		apply the patch to a client and then do another
     		<command>si_getimage</command> specifying a different imagename.  This is
     		preferred as it allows for revision control.
     	      </para>
     	    </listitem>
     	  </orderedlist>
     	</para>
           </listitem>
           
           <listitem>
     	<para>
     	  Run <command>si_updateclient</command> on the clients that you
     	  want to update.  Execute
     	  <command>si_updateclient -help</command> to get the syntax.
     	</para>
           </listitem>
         </orderedlist>
       </para>
     </answer>
  </qandaentry>
 
  <qandaentry>
     <question>
       <para>
         Is there a log file where autoinstall client status is kept?
       </para>
     </question>
     <answer>
       <para>
         Yes.  SystemImager logs can be found on the image server in the
         directory <filename>/var/log/systemimager</filename>
       </para>
     </answer>
  </qandaentry>
 
  <qandaentry>
   <question><para>What other software is SystemImager based on?</para></question>
   <answer>
    <para>
     SystemImager is mostly written in Perl, and makes use of the following software:
     <ItemizedList>
      <ListItem> <para><command>busybox</command></para> </ListItem>
      <ListItem> <para><command>bc</command></para> </ListItem>
      <ListItem> <para><command>devfsd</command></para> </ListItem>
      <ListItem> <para><command>ISC dhcp</command></para> </ListItem>
      <ListItem> <para><command>discover</command></para> </ListItem>
      <ListItem> <para><command>dosfstools</command></para> </ListItem>
      <ListItem> <para><command>e2fsprogs</command></para> </ListItem>
      <ListItem> <para><command>jfsutils</command></para> </ListItem>
      <ListItem> <para><command>xfsprogs</command></para> </ListItem>
      <ListItem> <para><command>Linux kernel</command></para> </ListItem>
      <ListItem> <para><command>parted</command></para> </ListItem>
      <ListItem> <para><command>pxelinux</command></para> </ListItem>
      <ListItem> <para><command>rsync</command></para> </ListItem>
      <ListItem> <para><command>syslinux</command></para> </ListItem>
      <ListItem> <para><command>raidtools</command></para> </ListItem>
      <ListItem> <para><command>reiserfsprogs</command></para> </ListItem>
      <ListItem> <para><command>systemconfigurator</command></para> </ListItem>
      <ListItem> <para><command>uClibc</command></para> </ListItem>
     </ItemizedList>
    </para>
    <para>
     Also be sure to take a look at System Installation Suite (SIS), which includes
     SystemInstaller, SystemImager, and System Configurator.  SystemInstaller is a 
     tool that allows you to install images directly to a SystemImager 
     image server.  System Configurator, which is also used by the standard SystemImager 
     release, performs configuration of target machine uniquenesses such as IP addresses, 
     network cards, and initial RAM disks needed to boot clients after installation.
    </para>
   </answer>
  </qandaentry>

  <qandaentry>
     <question>
      <para>
       I modified my <filename>autoinstallscript.conf</filename> file to configure my
	 non-software RAID image to install as a software RAID image,
	 but the install failed.  Why?
      </para>
     </question>
     <answer>
      <para>
       When you convert a non-software RAID image to a software RAID image, 
       you must manually configure the software RAID information.  Modify the 
	 image directly or make the changes in an override directory
	 if you want to maintain the original image. 
      </para>
      <para>
       Following are keypoints for manually
       configuring a computer to use software RAID on Linux.  For more
	 detailed information, please refer to
       <ulink url="http://unthought.net/Software-RAID.HOWTO/">The Software RAID HOWTO</ulink>
       at http://unthought.net/Software-RAID.HOWTO/.
      </para>
      <ItemizedList>
       <ListItem>
        <para>
         Drivers in the kernel: You must have the software RAID drivers
         compiled for the kernel your client will boot from when it finishes
         installing.  
        </para>
       </ListItem>
       <ListItem>
        <para>
         Device files:  For software RAID to work, you must have the
         proper device files in your image.  These device files have names like
         /dev/md0, /dev/md1, etc.  If these device files do not exist, cd into 
         the ./dev directory of your image, then copy and paste the following 
         command to create them.  If the software RAID devices are already
         created, running this command causes no problems.
        </para>
        <para>
         <LiteralLayout>
          for I in 0 1 2 3 4 5 6 7 8 9; do sudo mknod -m 660 md$I b 9 $I; done
         </LiteralLayout>
        </para>
       </ListItem>
       <ListItem>
        <para>
         /etc/raidtab: You must create this file and/or customize it to meet
         your needs.
        </para>
       </ListItem>
       <ListItem>
        <para>
         Other files: You must also modify the files used by your boot
         loader (lilo, grub, etc.).  See your boot loader's documentation for
         more information on its configuration file format.  A quick
         tip: in lilo.conf, instead of using /dev/md as for the boot=
         parameter, use the software RAID device that holds your
         /boot/ directory (where the kernel lives).  For example, if /dev/md1 
         will be mounted on /boot/, then specify boot=/dev/md1.
        </para>
       </ListItem>
      </ItemizedList>
      <para>
       After manually configuring your image to use software RAID,
       then make your changes to the autoinstallscript.conf file.  Changes 
       that you need to make to this file may include the following.
       See "<command>man autoinstallscript.conf</command>" for more information.
      </para>
      <ItemizedList>
       <ListItem>
        <para>
         In the <command>&lt;disk&gt;</command> section, add 
         <command>raid</command> to the comma separated list of flags for
         each partition that will participate in a RAID array.
        </para>
       </ListItem>
       <ListItem>
        <para>
         In the <command>&lt;fsinfo&gt;</command> section, set 
         <command>real_dev</command> to the software RAID device that will 
         hold each filesystem.
        </para>
       </ListItem>
      </ItemizedList>
      <para>
       You can now run <command>si_mkautoinstallscript</command> to create a new,
       software RAID-enabled autoinstallscript for your image.
      </para>
     </answer>
  </qandaentry>
 
  <qandaentry>
   <question>
    <para>
     What's an override directory?
    </para>
   </question>
   <answer>
    <para>
     An override directory is a directory that gets copied over to your target
     machines after the main image is transferred.  All contents in the override
     directory are copied over to the root of the target machine's new
     filesystem.  All file attributes are replicated, including directories,
     permissions, and ownership.  This allows you to "over-ride" files in the
     image.  Override directories live in
     <command>/var/lib/systemimager/overrides/</command>.
    </para>
    <para>
     You don't have to use an override directory, but it can often be useful.  
     For example, you could have two different autoinstall scripts for
     the same image: one for SCSI machines, and one for IDE machines.  You can
     have your /etc/fstab and /etc/lilo.conf files in override directories with
     names such as my_image-ide and my_image-scsi.
    </para>
    <para>
     Simply edit the master autoinstall script and change the overrides
     variable to include the appropriate override directory.  For example, you
     could change <command>OVERRIDES="my_image"</command> to 
     <command>OVERRIDES="my_image-ide"</command>.
    </para>
    <para>
     If using the same overrides on all of your machines, you don't
     have to change the autoinstall script.  Simply put the files that
     you want to override in the overrides directory that has the same name as
     your image, and proceed.
    </para>
    <para>
     You can also use multiple override directories, which are used in the order 
     that you specify them -- each directory 
     overriding the previous directories.  You can use this methodology in a
     highly complex environment where  slight variations exist between
     several classes of machines but where they all start with the same base
     image.  For example, <command>OVERRIDES="my_image-ide web_app"</command>.  
    </para>
   </answer>
  </qandaentry>

  <qandaentry>
   <question>
    <para>
     How do I expand a filesystem?
    </para>
   </question>
   <answer>
    <para>
     See "How do I change the size of a partition?"
    </para>
   </answer>
  </qandaentry>
 
  <qandaentry>
   <question>
    <para>
     How do I change the size of a partition?
    </para>
   </question>
   <answer>
    <para>
     <orderedlist>
      <listitem>
       <para>
        Open your autoinstallscript.conf file in your favourite text editor.
       </para>
	      <note>
		<para>
		  The default autoinstallscript.conf file created by
		  <command>si_prepareclient</command> lives in the 
		  <filename>/etc/systemimager</filename> directory in your 
		  image.
		</para>
	      </note>
      </listitem>
      <listitem>
       <para>
        Find the <command>&lt;disk&gt;</command> section where
        <command>dev</command> is set to the disk that holds the partition 
        you want to change.
       </para>
      </listitem>
      <listitem>
       <para>
        Find the <command>&lt;part&gt;</command> entry where 
        <command>num</command> is the number of the partition in question.
       </para>
      </listitem>
      <listitem>
       <para>
        Change <command>size</command> to the new partition size, keeping in mind that if the size
        you specify is not sufficient to hold the files stored there,
        the autoinstall will fail.
       </para>
       <para>
        NOTE: Each <command>&lt;disk&gt;</command> section can use either MB
        (megabytes) or % (percentages) to specify partition sizes.  See  
        <command>man autoinstallscript.conf</command> for more information.
       </para>
      </listitem>
      <listitem>
       <para>
        Run <command>si_mkautoinstallscript</command> to create a new 
        autoinstall script using the new parameters.
       </para>
       <para>
        NOTE: By default, <command>si_mkautoinstallscript</command> uses the
        autoinstallscript.conf file located in your image's ./etc/systemimager directory.  
        See <command>man si_mkautoinstallscript</command> and 
        <command>man autoinstallscript.conf</command> for more information.
       </para>
      </listitem>
     </orderedlist>
    </para>
   </answer>
  </qandaentry>

  <qandaentry>
   <question>
    <para>
     How do I change the filesystem(s) that my target machine(s) will use?
    </para>
   </question>
   <answer>
    <para>
     <orderedlist>
      <listitem>
       <para>
        Make sure that the kernel in your image supports the filesystem(s) 
        you want to use.
       </para>
      </listitem>
      <listitem>
       <para>
        Open your autoinstallscript.conf file in your favorite text editor.
       </para>
       <para>
        NOTE: The default autoinstallscript.conf file created by
        <command>si_prepareclient</command> lives in the ./etc/systemimager
        directory in your image.
       </para>
      </listitem>
      <listitem>
       <para>
        Find the <command>&lt;fsinfo&gt;</command> entry where
        <command>mp</command> (mount point) is set to the filesystem that you 
        want to change.
       </para>
      </listitem>
      <listitem>
       <para>
        Change <command>fs</command> to the filesystem you want to use.
        See <command>man autoinstallscript.conf</command> for a list of
        supported filesystems.
       </para>
       <para>
        You must understand the capabilities of your chosen filesystem.  Depending on which
	  one you use, you may also need to change the options used to mount the filesystem, which
	  are set by the <command>options</command> entry.  If you choose unsupported
        options, your autoinstall may fail.
       </para>
       <para>
        In all known cases to date, it has not been necessary to change the <command>fs</command> 
	  entries in the <command>&lt;disk&gt;</command> section when changing filesystem types.
        The <command>fs</command> entries in the 
        <command>&lt;disk&gt;</command> section don't actually determine the
        filesystem that will be created on those partitions, but the 
        <command>parted</command> tool that SystemImager uses for creating disk
        partitions requires that argument.
       </para>
      </listitem>
      <listitem>
       <para>
        Run <command>si_mkautoinstallscript</command> to create a new 
        autoinstall script using the new parameters. By default, 
	  <command>si_mkautoinstallscript</command> uses the autoinstallscript.conf 
	  file located in the ./etc/systemimager directory in
        your image.  See <command>man si_mkautoinstallscript</command> and 
        <command>man autoinstallscript.conf</command> for more information.
       </para>
      </listitem>
     </orderedlist>
    </para>
   </answer>
  </qandaentry>
 
  <qandaentry>
   <question>
    <para>
     How do I change the disk type(s) that my target machine(s) will use?
    </para>
   </question>
   <answer>
    <para>
     <orderedlist>
      <listitem>
       <para>
        Make sure that the kernel in your image has drivers for the disk types
        you want to use.  
       </para>
      </listitem>
      <listitem>
       <para>
        Open your autoinstallscript.conf file in your favorite text editor.
       </para>
	      <note>
		<para>
		  The default autoinstallscript.conf file created by
		  <command>si_prepareclient</command> lives in the 
		  <filename>/etc/systemimager</filename>
		  directory in your image.
		</para>
	      </note>
      </listitem>
      <listitem>
       <para>
        Find the <command>&lt;disk&gt;</command> entry where
        <command>dev</command> (disk device) is set to the disk that you 
        want to change.
       </para>
      </listitem>
      <listitem>
       <para>
        Change <command>dev</command> to the device file for the disk you want
        to use.  For example, changing from SCSI to IDE can be as simple as changing
        <command>dev="/dev/sda"</command> to <command>dev="/dev/hda"</command>.
       </para>
      </listitem>
      <listitem>
       <para>
        Change the <command>real_dev</command> entries in the 
        <command>&lt;fsinfo&gt;</command> section to match the new devices.
       </para>
      </listitem>
      <listitem>
       <para>
        Run <command>si_mkautoinstallscript</command> to create a new 
        autoinstall script using the new parameters.
       </para>
	      <note>
		<para>
		  By default, <command>si_mkautoinstallscript</command> uses the
		  <filename>autoinstallscript.conf</filename> file located in 
		  the <filename>/etc/systemimager</filename> directory in your
		  image.  See <command>man si_mkautoinstallscript</command> and 
		  <command>man autoinstallscript.conf</command> for more
		  information.
		</para>
	      </note>
      </listitem>
      <listitem>
       <para>
        Modify the boot loader configuration in your image to work with your
        target disk configuration.
       </para>
      </listitem>
     </orderedlist>
    </para>
   </answer>
  </qandaentry>
 
  <qandaentry>
   <question>
    <para>
     Can I use a single image across machines with differing disk or
     partition configurations?
    </para>
   </question>
   <answer>
    <para>
     Yes.  Customize a separate autoinstallscript.conf file for each
     configuration type, and use <command>si_mkautoinstallscript</command> to
     create a seperate master autoinstallscript for each configuration.
    </para>
    <para>
     If a particular configuration's boot device will be different from the boot
     device in the image, you also need to put a customized copy of your
     boot loader's configuration file(s) in an override directory.
    </para>
    <para>
     See the following "Frequently Asked Questions" for more information:
    </para>
    <para>
     <itemizedlist>
      <listitem>
       <para>
        How do I change the size of a partition?
       </para>
      </listitem>
      <listitem>
       <para>
        How do I change the filesystem(s) that my target machine(s) will use?
       </para>
      </listitem>
      <listitem>
       <para>
        How do I change the disk type(s) that my target machine(s) will use?
       </para>
      </listitem>
      <listitem>
       <para>
        What's an override directory?
       </para>
      </listitem>
     </itemizedlist>
    </para>
   </answer>
  </qandaentry>
 
 </qandaset>
</chapter>
